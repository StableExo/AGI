# Operation: Citadel Upgrade - Architectural Plan

## 1. Directive Analysis

This document outlines the end-to-end technical plan for upgrading the `gemini-citadel`'s on-chain execution engine, `FlashSwap.sol`, to utilize the Uniswap Universal Router. This upgrade is a strategic directive aimed at enhancing profitability, reducing gas costs, and aligning our infrastructure with the future of the Uniswap protocol.

The analysis of the Universal Router reveals a powerful, command-based architecture. Instead of discrete calls for each swap, it accepts a `bytes` array of commands and a `bytes[]` array of corresponding inputs, executing an entire trade path in a single, atomic transaction. This represents a fundamental shift from our current `ISwapRouter` implementation.

Furthermore, analysis of the `gemini-citadel` off-chain services revealed that the `ExecutionManager.ts` responsible for DEX trades is a placeholder. Therefore, the off-chain portion of this upgrade will be a greenfield implementation, not a refactor.

## 2. End-to-End Upgrade Plan

The upgrade is divided into three core components: the on-chain contract refactor, the off-chain implementation of the execution logic, and a comprehensive, multi-layered testing strategy.

### Part 1: On-Chain Refactor (`FlashSwap.sol`)

The `FlashSwap.sol` contract will be surgically upgraded to remove all dependencies on `ISwapRouter` and integrate the `IUniversalRouter`.

1.  **Replace Core Dependency:**
    *   The `ISwapRouter` state variable will be removed.
    *   It will be replaced with an `IUniversalRouter` interface, pointing to the new router.
    *   The `constructor` will be updated to accept the Universal Router's address.

2.  **Update Data Structures for Command-Based Execution:**
    *   The `SwapStep` struct, designed for iterative swaps, will be removed.
    *   The `ArbParams` struct will be redesigned. The `SwapStep[] path` field will be replaced with `bytes commands` and `bytes[] inputs`.

3.  **Streamline Execution Logic:**
    *   The `_executeSwapPath` internal function will be removed.
    *   The flash loan callbacks (`uniswapV3FlashCallback`, `executeOperation`) will be refactored to:
        a.  Decode `commands` and `inputs` from the `ArbParams`.
        b.  Approve the Universal Router to spend the flash-loaned asset.
        c.  Call `UNIVERSAL_ROUTER.execute{value: msg.value}(commands, inputs)` to perform the arbitrage.

### Part 2: Off-Chain Implementation (New Services & `ExecutionManager.ts`)

New off-chain services will be created to construct and encode the command-based transactions.

1.  **Create `UniversalRouterEncoder.service.ts`:**
    *   A new, dedicated service will be created to encode trade paths into the Universal Router's format.
    *   This service will contain methods like `encodeV3SwapExactIn`, which will take a trade action and produce the `bytes1` command and ABI-encoded `bytes` input required by the `Dispatcher.sol` contract.

2.  **Implement `ExecutionManager.ts` On-Chain Logic:**
    *   The `executeTrade` method will be implemented to orchestrate the on-chain execution flow:
        a.  Receive an `ArbitrageOpportunity`.
        b.  Utilize the `UniversalRouterEncoder` service to transform the opportunity's trade actions into `commands` and `inputs` byte arrays.
        c.  Construct the updated `ArbParams` struct with these byte arrays.
        d.  ABI-encode the `ArbParams`.
        e.  Build and submit the transaction to the `FlashSwap.sol` contract's `initiateAaveFlashLoan` function.

### Part 3: Comprehensive Testing Strategy

A multi-layered testing strategy will ensure the correctness and robustness of the upgraded system.

1.  **Off-Chain Unit Tests (Jest):**
    *   **`UniversalRouterEncoder.service.test.ts`**: Rigorous tests will be written to validate that for known inputs, the generated byte strings exactly match pre-calculated, known-good values.
    *   **`ExecutionManager.ts`**: The `executeTrade` function will be tested using mocks to verify its orchestration logic.

2.  **On-Chain Integration Tests (Hardhat):**
    *   A new test suite, `FlashSwap-UR.test.ts`, will be created.
    *   Using a fork of the Base mainnet, the upgraded `FlashSwap.sol` contract will be deployed.
    *   End-to-end arbitrage cycles will be simulated by calling `initiateAaveFlashLoan` with manually-crafted, valid `commands` and `inputs`, verifying that the contract correctly executes the trades via the real Universal Router and repays the flash loan.
