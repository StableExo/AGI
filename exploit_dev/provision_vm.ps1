# provision_vm.ps1
# This script configures a fresh Windows 7 SP1 installation to create a controlled
# environment for "Operation Forge the Key".
# It should be run with Administrator privileges.

# ---
# 1. Disable Windows Automatic Updates
# ---
# To ensure the environment remains a "time capsule" at the SP1 level, we disable
# the Windows Update service.
Write-Host "Disabling Windows Update service..."
# Stop the service if it's running
Stop-Service -Name wuauserv -Force -ErrorAction SilentlyContinue
# Set the service startup type to Disabled
Set-Service -Name wuauserv -StartupType Disabled
Write-Host "Windows Update service has been disabled."

# ---
# 2. Enable PowerShell Remoting
# ---
# This enables remote management, which is the primary method for deploying and
# executing tools within the VM. The -Force flag skips the interactive prompts.
Write-Host "Enabling PowerShell Remoting..."
Enable-PSRemoting -Force
Write-Host "PowerShell Remoting has been enabled."

# ---
# 3. Disable Network Adapter
# ---
# To create an "air-gapped" environment and prevent any external contamination,
# we disable all non-loopback network adapters.
Write-Host "Disabling network adapters..."
# Get all network adapters that are not loopback and are enabled
$adapters = Get-WmiObject -Class Win32_NetworkAdapter -Filter "NetConnectionID != NULL AND NOT Name LIKE 'Microsoft Loopback%'"
if ($adapters) {
    foreach ($adapter in $adapters) {
        $adapterName = $adapter.NetConnectionID
        Write-Host "Disabling adapter: $adapterName"
        # The command to disable the adapter
        (Get-WmiObject -Class Win32_NetworkAdapter -Filter "NetConnectionID='$adapterName'").Disable()
    }
    Write-Host "All non-loopback network adapters have been disabled."
} else {
    Write-Host "No active, non-loopback network adapters found to disable."
}

Write-Host "---"
Write-Host "VM Provisioning Complete."
Write-Host "The system is now configured according to the 'Factory Default' protocol."
Write-Host "Please shut down the VM and take a snapshot of this clean state."